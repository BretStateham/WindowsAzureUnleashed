
<!DOCTYPE html>
<html class="no-js" lang="en" class="js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients no-cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<head id="ContentPlaceHolderDefault_Head1">
    <meta http-equiv="X-UA-Compatible" content="IE=9,chrome=1" />
    <meta charset="utf-8" />
    <title>Windows Azure Training Kit - Introduction to Building Windows Store Apps with Windows Azure Mobile Services</title>
    <link rel="Stylesheet" type="text/css" media="all" href="styles/master.css" />
</head>
<body id="top" class="page-">
    <div id="page">
        <div id="wrapper" class="landingPage getStartedPage">            
            <div class="header">								
				<img alt="Windows Azure" src="images/azure-logo.png" />
				<span class="mainHomepageSubTitle">Training Kit - August 2013 Update</span>								
			</div>			
			<div class="nav-menu-header">
				<nav>
					<ul>
						<li class="MenuLink-Selected">
							<a href="#">Content</a>
						</li>
												<li class="MenuLink">
							<a href="Source">Setup</a>
						</li>
											</ul>
				
										
						<span id="github-btn" class="github-btn">
						  <a id="gh-btn" title="Fork this repo in GitHub" href="https://github.com/WindowsAzure-TrainingKit/HOL-Windows8AndMobileServices" target="_blank" class="gh-btn">
							<span class="gh-ico"></span>
							<span id="gh-text" class="gh-text">Fork</span>
						  </a>								  
						</span>								
						<span id="github-btn" class="github-btn github-watchers">
						  <a id="gh-btn" title="Watch this repo in GitHub" href="https://github.com/WindowsAzure-TrainingKit/HOL-Windows8AndMobileServices" target="_blank" class="gh-btn">
							<span class="gh-ico"></span>
							<span id="gh-text" class="gh-text">Watch</span>
						  </a>								  
						</span>
						
									
				</nav>
			</div>	        
		</span>
			<div id="content" class="textpage">
            <section id="content-container">
				<div id="content" class="textpage">
			    <a name="top"></a>
				
				

		<div class="content">
			<?xml version="1.0" encoding="iso-8859-1"?><span><p><a name="title"></a></p>

<h1 id="Introduction_to_Building_Windows_Store_Apps_with_Windows_Azure_Mobile_Services">Introduction to Building Windows Store Apps with Windows Azure Mobile Services</h1>

<hr />

<p><a name="Overview"></a></p>

<h2 id="Overview">Overview</h2>

<p>In this HOL you will learn how you can leverage Visual Studio 2012 and Windows Azure Mobile Services to add structured storage, push notifications and integrated authentication to your Windows Store applications.</p>

<p><a name="Objectives"></a></p>

<h3 id="Objectives">Objectives</h3>

<ul>
<li>Create a Windows Azure Mobile Service.</li>
<li>Use the Windows Azure Mobile Services SDK.</li>
<li>Learn how to Insert, Update, Read and Delete rows from a Mobile Service.</li>
<li>Add Push Notifications to your application.</li>
<li>Lock down your Mobile Service such that only authenticated users can consume it.</li>
<li>Add a Scheduled Job to poll the Twitter API and send Tile updates.</li>
</ul>

<p><a name="technologies"></a></p>

<h3 id="Prerequisites">Prerequisites</h3>

<ul>
<li>Windows Azure subscription with Mobile Services preview enabled - <a href="http://www.windowsazure.com/en-us/develop/mobile/tutorials/create-a-windows-azure-account/">Create a Windows Azure account and enable preview features</a></li>
<li><a href="http://www.microsoft.com/visualstudio">Visual Studio Express 2012 for Windows 8</a> or higher</li>
</ul>

<p><a name="Exercises"></a></p>

<h2 id="Exercises">Exercises</h2>

<p>This hands-on lab includes the following exercises:</p>

<ol>
<li><a href="#Exercise1">Creating your first Mobile Service</a></li>
<li><a href="#Exercise2">Adding Push Notifications to your app</a></li>
<li><a href="#Exercise3">Adding Auth to Your App and Services</a></li>
<li><a href="#Exercise4">Adding a Scheduled Job to your Mobile Service</a></li>
</ol>

<p><a name="Exercise1"></a></p>

<h2 id="Exercise_1_Creating_your_first_Mobile_Service">Exercise 1: Creating your first Mobile Service</h2>

<p>This exercise shows you how to add a cloud-based backend service to a Windows 8 app using Windows Azure Mobile Services.  You will create both a new mobile service and a simple <em>To do list</em> app that stores app data in the new mobile service.</p>

<p>A screenshot from the completed app is below:</p>

<p><img src="Images/image-1.png?raw=true" alt="Image 1" />
</p>

<p><a name="create-a-new-mobile-service"></a></p>

<h3 id="Task_1_-_Creating_a_new_mobile_service">Task 1 - Creating a new mobile service</h3>

<p>Follow these steps to create a new mobile service.</p>

<ol>
<li><p>Log into the <a href="https://manage.windowsazure.com">Windows Azure Management Portal</a> and navigate to Mobile Services.</p></li>
<li><p>Click the <strong>+New</strong> button.</p>

<p><img src="Images/image-2.png?raw=true" alt="image-2" />
</p></li>
<li><p>Expand <strong>Compute | Mobile Service</strong>, then click <strong>Create</strong>.</p>

<p><img src="Images/image-3.png?raw=true" alt="Image 3" />
</p>

<p>This displays the <strong>New Mobile Service</strong> dialog.</p></li>
<li><p>In the <strong>Create a mobile service</strong> page, type a subdomain name for the new mobile service in the <strong>URL</strong> textbox and wait for name verification. Once name verification completes, click the right arrow button to go to the next page.</p>

<p><img src="Images/image-4.png?raw=true" alt="Image 4" />
</p>

<p>This displays the <strong>Specify database settings</strong> page.</p>
<blockquote>
<p><strong>Note:</strong> As part of this exercise, you create a new SQL Database instance and server. You can reuse this new database and administer it as you would do with any other SQL Database instance. If you already have a database in the same region as the new mobile service, you can instead chooseUse existing Databaseand then select that database. The use of a database in a different region is not recommended because of additional bandwidth costs and higher latencies.</p>
</blockquote></li>
<li><p>In <strong>Name</strong>, type the name of the new database, then type <strong>Login name</strong>, which is the administrator login name for the new SQL Database server, type and confirm the password, and click the check button to complete the process.</p>

<p><img src="Images/image-5.png?raw=true" alt="Image 5" />
</p>
<blockquote>
<p><strong>Note:</strong>  When the password that you supply does not meet the minimum requirements or when there is a mismatch, a warning is displayed.  We recommend that you make a note of the administrator login name and password that you specify; you will need this information to reuse the SQL Database instance or the server in the future. You have now created a new mobile service that can be used by your mobile apps.</p>
</blockquote></li>
</ol>

<p>You have now created a new mobile service that can be used by your mobile apps.</p>

<p><a name="create-a-new-app"></a></p>

<h3 id="Task_2_-_Creating_a_new_app">Task 2 - Creating a new app</h3>

<p>Once you have created your mobile service, you can follow an easy quick start in the Management Portal to either create a new Windows Store app or modify an existing app to connect to your mobile service.</p>

<ol>
<li><p>In the Management Portal, click <strong>Mobile Services</strong>, and then click the mobile service that you just created.</p></li>
<li><p>In the quickstart tab, make sure that <strong>Windows Store</strong> is selected as the <strong>Platform</strong>, and expand <strong>Create a new Windows Store app</strong>.</p>

<p><img src="Images/image-6.png?raw=true" alt="Image 6" />
</p>

<p>This displays the three easy steps to create a Windows 8 app connected to your mobile service.</p>

<p><img src="Images/image-7.png?raw=true" alt="Image 7" />
</p></li>
<li><p>If you haven't already done so, download and install <a href="http://go.microsoft.com/fwlink/?LinkId=257546&amp;clcid=0x409">Visual Studio 2012 Express for Windows 8</a> on your local computer or virtual machine.</p></li>
<li><p>Click <strong>Create TodoItem Table</strong> to create the table in the database.</p></li>
<li><p>Lastly, make sure that the <strong>C#</strong> language is selected and click <strong>Download</strong>.</p>

<p>This downloads the project for the sample <em>Todo list</em> application that is connected to your mobile service. Save the compressed project file to your local computer, and make a note of where you save it.</p></li>
</ol>

<p><a name="run-your-app"></a></p>

<h3 id="Task_3_-_Running_your_app">Task 3 - Running your app</h3>

<ol>
<li><p>Browse to the location where you saved the compressed project files, extract the files on your computer, and open the solution file in Visual Studio 2012 Express for Windows 8.</p>

<p><img src="Images/image-23.png?raw=true" alt="Image 23" />
</p></li>
<li><p>Expand the <strong>References</strong> node in the project and notice that many references are missing. These references will be downloaded as nuget packages when the app is compiled the first time. The <em>Windows Azure Mobile SDK</em> is now downloaded as a nuget package.</p></li>
<li><p>Press the <strong>F5</strong> key to build the project, download the required dependencies, and start the app.</p></li>
<li><p>In the app, type meaningful text, such as <em>Complete the lab</em>, in the <strong>Insert a TodoItem</strong> textbox, and then click <strong>Save</strong>.</p>

<p><img src="Images/image-9.png?raw=true" alt="Image 9" />
</p>

<p>This sends a POST request to the new mobile service hosted in Windows Azure. Data from the request is inserted into the TodoItem table. Items stored in the table are returned by the mobile service, and the data is displayed in the second column in the app.</p>
<blockquote>
<p><strong>Note:</strong> You can review the code that accesses your mobile service to query and insert data, which is found in the MainPage.xaml.cs file.</p>
</blockquote></li>
<li><p>Back in the Management Portal, click the <strong>Data</strong> tab and then click the <strong>TodoItems</strong> table and observe that the data has been successfully stored.</p>

<p><img src="Images/image-10.png?raw=true" alt="Image 10" />
</p>

<p>This lets you browse the data inserted by the app into the table.</p>

<p><img src="Images/image-11.png?raw=true" alt="Image 11" />
</p></li>
</ol>

<p><a name="Explore-your-app-code"></a></p>

<h3 id="Task_4_-_Exploring_your_app_code">Task 4 - Exploring your app code</h3>

<p>In this step we explore <em>Todo list</em> application code and see how simple the Windows Azure Mobile Services Client SDK makes it to interact with Windows Azure Mobile Services.</p>

<ol>
<li><p>Return to the downloaded <em>Todo list</em> application in Visual Studio 2012 Express for Windows 8.</p></li>
<li><p>In solution explorer expand the <strong>References</strong> folder and notice <strong>Microsoft.WindowsAzure.Mobile</strong>, which is the reference for the <em>Windows Azure mobile Services Client SDK</em>. </p></li>
<li><p>Open <strong>App.xaml.cs</strong> and show the <em>MobileServiceClient</em> class.  This is the key class provided by the Mobile Services client SDK that provides a way for your application to interact with Windows Azure Mobile Services. The first parameter in the constructor is the Mobile Service endpoint and the second parameter is the Application Key for your Mobile Service.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">static</span> MobileServiceClient MobileService 
        = <span style="color:#0000FF">new</span> MobileServiceClient( 
            <span style="color:#8B0000">&quot;https://todolist.azure-mobile.net/&quot;</span>
            ,<span style="color:#8B0000">&quot;vIWepmcOXGPsYCJQDDcFBKsnOVxzLG52&quot;</span> );

</code></pre></li>
<li><p>Open <strong>MainPage.xaml.cs</strong> to observe how the mobile service client is then used for Inserts, Updates, Reads and Deletes:</p>

<p>The source creates a handle for operations on a table:</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">private</span> IMobileServiceTable&lt;TodoItem&gt; todoTable = App.MobileService.GetTable&lt;TodoItem&gt;();       
</code></pre>

<p>Performs an Insert:</p>

<!-- mark:3;   -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">private</span> <span style="color:#0000FF">async</span> <span style="color:#0000FF">void</span> InsertTodoItem(TodoItem todoItem)
{
<strong class="markLine">    <span style="color:#0000FF">await</span> todoTable.InsertAsync(todoItem);</strong>
    items.Add(todoItem);                        
}
</code></pre>

<p>Performs an Update:</p>

<!-- mark:3    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">private</span> <span style="color:#0000FF">async</span> <span style="color:#0000FF">void</span> UpdateCheckedTodoItem(TodoItem item)
{
<strong class="markLine">    <span style="color:#0000FF">await</span> todoTable.UpdateAsync(item);</strong>
    items.Remove(item);
}
</code></pre>

<p>Performs a Read:</p>

<!-- mark:3-4    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> RefreshTodoItems()
{
<strong class="markLine">    items = todoTable</strong>
<strong class="markLine">         .Where(todoItem =&gt; todoItem.Complete == <span style="color:#0000FF">false</span>)</strong>
         .ToCollectionView();
    ListItems.ItemsSource = items;
}
</code></pre></li>
<li><p>As an extension see if you can update the <em>UpdateCheckedTodoItem</em> method to perform a delete rather then update operation using the todoTable.DeleteAsync(...) method.</p></li>
</ol>

<p><a name="Exercise2"></a></p>

<h2 id="Exercise_2_Adding_Push_Notifications_to_your_app">Exercise 2: Adding Push Notifications to your app</h2>

<p>In this exercise, you will add push notifications, using the Windows Push Notification service (WNS), to the project. When completed, an insert in the mobile service todolist table will generate a push notification back to your app. </p>

<p><a name="Registering-your-app-for-push-notifications-and-configure-Mobile-Services"></a></p>

<h3 id="Task_1_-_Registering_your_app_for_push_notifications_and_configure_Mobile_Services">Task 1 - Registering your app for push notifications and configure Mobile Services</h3>

<ol>
<li><p>Click <strong>Store</strong> in the Visual Studio menu and select <strong>Reserve App Name</strong>. Additionally, you can find the <strong>Reserve App Name</strong> option under the <strong>Project | Store</strong> menu in some Visual Studio versions. </p>

<p><img src="./Images/reserving-app-name.png?raw=true" alt="Reserving App Name" />
</p></li>
<li><p>The browser will display the Windows Store page that you will use to obtain your WNS credentials. In the Submit an app section, click <strong>App Name</strong>.</p>
<blockquote>
<p><strong>Note:</strong> You will have to sign in using your Microsoft Account to access the Windows Store.</p>
</blockquote>
<p><img src="./Images/giving-app-name-windows-store.png?raw=true" alt="Giving your app a unique name" />
</p></li>
<li><p>In the App name field, insert the Package Display Name that is inside the <strong>package.appxmanifest</strong> file of your solution and click <strong>Reserve app name</strong>. Then click <strong>Save</strong> to confirm the reservation.</p>

<p><img src="./Images/app-name-windows-store.png?raw=true" alt="Reserving an app name" />
</p>

<p><img src="./Images/name-reservation-successful-win-store.png?raw=true" alt="Confirming the app name reservation" />
</p></li>
<li><p>Now you will have to identify your application to get a name and a publisher to insert in the <strong>package.appxmanifest</strong> file. In the Submit an app page, click <strong>Advanced features</strong>.</p>

<p><img src="./Images/app-name-reverved-completely-windows-store.png?raw=true" alt="Configuring push notifications for the Notifications.Client app" />
</p></li>
<li><p>In the Advanced features page, click <strong>Push notifications and Live Connect services info</strong>.</p>

<p><img src="./Images/push-notif-live-connect-service-info.png?raw=true" alt="Advanced features page" />
</p></li>
<li><p>Once in the Push notifications and Live Connect services info section, click <strong>Identifying your app</strong>.</p>

<p><img src="./Images/identifying-your-app.png?raw=true" alt="Push notifications Overview page" />
</p></li>
<li><p>Now we have to set the Identity Name and Publisher of our <strong>package.appxmanifest</strong> file with the information in Windows Store. Go back to Visual Studio, right-click the <strong>package.appxmanifest</strong> and select <strong>View Code</strong>. Replace the Name and Publisher attributes of the Identity element with the ones obtained in Windows Store. Click <strong>Authenticating your service</strong>.</p>

<p><img src="./Images/app-identification.png?raw=true" alt="Setting Identity Name and Publisher" />
</p></li>
<li><p>Finally you obtained a <strong>Package Security Identifier (SID)</strong> and a <strong>Client secret</strong>, which are the WNS Credentials that we need to update the Web configuration of our Notification App Server.</p>

<p><img src="./Images/sid-client-secret.png?raw=true" alt="Package Security Identifier (SID) and Client secret" />
</p>
<blockquote>
<p><strong>Note:</strong> The client secret and package SID are important security credentials. Do not share these secrets with anyone or distribute them with your app.</p>
</blockquote></li>
<li><p>Log on to the <a href="https://manage.windowsazure.com/">Windows Azure Management Portal</a>, click <strong>Mobile Services</strong>, and then click your app.</p>

<p><img src="Images/image-13.png?raw=true" alt="Image 13" />
</p></li>
<li><p>Click the <strong>Push</strong> tab, enter the <strong>Client secret</strong> and <strong>Package SID</strong> values obtained for WNS above, and click <strong>Save</strong>.</p>

<p><img src="Images/image-14.png?raw=true" alt="Image 14" />
</p>
<blockquote>
<p><strong>Note:</strong> In the following steps you will associate your application with the Windows Store. If you obtained your WNS credentials from the Windows Push Notifications &amp; Live Connect Portal, there is no need to execute these steps.</p>
</blockquote></li>
<li><p>Click <strong>Store</strong> or <strong>Project | Store</strong> in the Visual Studio menu and select <strong>Associate App with the Store</strong>.</p>

<p><img src="./Images/associating-app-with-store.png?raw=true" alt="Associating App with Store" />
</p></li>
<li><p>In the Associate Your App with the Windows Store wizard, click <strong>Sign In</strong>.</p>

<p><img src="./Images/associate-app-with-store.png?raw=true" alt="Associating App with Store Wizard" />
</p></li>
<li><p>Enter your credentials and click <strong>Sign In</strong>.</p>

<p><img src="./Images/sign-in-for-association.png?raw=true" alt="Inserting your credentials to assciate your app in Windows Store" />
</p></li>
<li><p>In the Select an app name step, select <strong>Notifications.Client</strong> and click <strong>Next</strong>.</p>

<p><img src="./Images/selecting-app-name.png?raw=true" alt="Selecting your app name" />
</p></li>
<li><p>Take a look at the summary of the values that will be added in the manifest file. Click <strong>Associate</strong>. </p>

<p><img src="./Images/association-summary.png?raw=true" alt="Associating your app with the Windows Store Summary" />
</p></li>
<li><p><strong>Close</strong> and <strong>Save</strong> changes to <strong>package.appxmanifest</strong>.</p></li>
</ol>

<p><a name="Adding-push-notifications-to-the-app"></a></p>

<h3 id="Task_2_-_Adding_push_notifications_to_the_app">Task 2 - Adding push notifications to the app</h3>

<ol>
<li><p>In Visual Studio open the <strong>package.appxmanifest</strong>, select the <strong>Application UI</strong> tab and ensure <strong>toast capable</strong> is set to <em>yes</em>.  </p>
<blockquote>
<p><strong>Note:</strong> If you wish to send Wide Tiles then you must provide a default wide tile in the Wide Logo field.</p>
</blockquote></li>
<li><p>Right-click the TodoList project, select <strong>Add | Class</strong> and name it <strong>Channel.cs</strong>. Then insert the following properties into it:  </p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> Channel
{
    <span style="color:#0000FF">public</span> <span style="color:#0000FF">int</span>? Id { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }
    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> Uri { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }
}

</code></pre></li>
<li><p>Open the file <strong>App.xaml.cs</strong>.</p></li>
<li><p>Add the following using statements:</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> Windows.Networking.PushNotifications;
<span style="color:#0000FF">using</span> Windows.Storage;
</code></pre></li>
<li><p>Find the OnLaunched method and mark it to be <strong>async</strong> as follows.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">protected</span> <span style="color:#0000FF">async</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> OnLaunched(LaunchActivatedEventArgs args)
</code></pre></li>
<li><p>Add the following lines of code at the end of OnLaunched to request a notification channel and register it with your Mobile Services app.</p>

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">var</span> ch = <span style="color:#0000FF">await</span> PushNotificationChannelManager.CreatePushNotificationChannelForApplicationAsync();
<span style="color:#0000FF">var</span> channelDTO = <span style="color:#0000FF">new</span> Channel()
              {
                    Id = ApplicationData.Current.LocalSettings.Values[<span style="color:#8B0000">&quot;ChannelId&quot;</span>] <span style="color:#0000FF">as</span> <span style="color:#0000FF">int</span>?,
                    Uri = ch.Uri
              };

<span style="color:#0000FF">if</span> (ApplicationData.Current.LocalSettings.Values[<span style="color:#8B0000">&quot;ChannelId&quot;</span>] == <span style="color:#0000FF">null</span>)
{
     <span style="color:#0000FF">await</span> MobileService.GetTable&lt;Channel&gt;().InsertAsync(channelDTO);
     ApplicationData.Current.LocalSettings.Values[<span style="color:#8B0000">&quot;ChannelId&quot;</span>] = channelDTO.Id;
}
<span style="color:#0000FF">else</span>
{
     <span style="color:#0000FF">await</span> MobileService.GetTable&lt;Channel&gt;().UpdateAsync(channelDTO);
}
</code></pre></li>
</ol>

<p>Now that you have the client wired up to request a channel and write it to the Mobile Service you need to add a Channel table to the Mobile Service and add a server side script to send push notifications.</p>

<p><a name="Inserting-data-to-receive-notifications"></a></p>

<h3 id="Task_3_-_Inserting_data_to_receive_notifications">Task 3 - Inserting data to receive notifications</h3>

<p>In this task you will add a Channel table and server side scripts to send push notifications everytime someone inserts into our todolist.  </p>

<ol>
<li><p>Return to the <a href="https://manage.windowsazure.com/">Windows Azure Management Portal</a>, click <strong>Mobile Services</strong>, and then click your app.</p></li>
<li><p>Select the <strong>Data</strong> tab.</p></li>
<li><p>Click <strong>Create</strong> in the bottom toolbar.</p>

<p><img src="Images/image-19.png?raw=true" alt="Image 19" />
</p></li>
<li><p>In <strong>Table name</strong> type <em>Channel</em>, then click the check button.</p>

<p><img src="Images/image-20.png?raw=true" alt="Image 20" />
</p></li>
<li><p>Click the new <strong>Channel</strong> table and verify that there are no data rows.</p></li>
<li><p>Click the <strong>Columns</strong> tab and verify that there is only a single <strong>id</strong> column, which is automatically created for you.
This is the minimum requirement for a table in Mobile Services.</p>
<blockquote>
<p><strong>Note:</strong> When dynamic schema is enabled on your mobile service, new columns are created automatically when JSON objects are sent to the mobile service by an insert or update operation.</p>
</blockquote></li>
<li><p>Now in the left navbar select the <strong>TodoItem</strong> table.</p></li>
<li><p>Click the <strong>Script</strong> tab and select the <strong>Insert</strong> Operation and replace the existing script with the following and walk through the following code.</p>

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><span style="color:#0000FF">function</span> insert(item, user, request) {       
     request.execute({
          success: <span style="color:#0000FF">function</span>(){
                request.respond();
                sendNotifications(item);
          },
          error: <span style="color:#0000FF">function</span>(err){
                request.respond(500, <span style="color:#8B0000">&quot;Error&quot;</span>);
          }
     });
}

<span style="color:#0000FF">function</span> sendNotifications(item){                        
  <span style="color:#0000FF">var</span> channelTable = tables.getTable(&#39;Channel&#39;); 
  channelTable.read({ 
     success: <span style="color:#0000FF">function</span>(channels){
         channels.forEach(<span style="color:#0000FF">function</span>(channel){    
             push.wns.sendToastText04(channel.Uri, {
                  text1: item.text,
                  text2: <span style="color:#8B0000">&quot;Hello World 1&quot;</span>,
                  text3:  <span style="color:#8B0000">&quot;Hello World 2&quot;</span>
             }, {
                  success: <span style="color:#0000FF">function</span>(response){                                               
                      console.log(response);
                  },                                   
                  error: <span style="color:#0000FF">function</span>(err){                                               
                        console.error(err);                       
                  }                    
             });
        });
  }        
});    
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> This script executes each time an insert operation is executed on the Todoitem table.  The sendNotifications method will select all channels from the Channels table and iterate through them sending a push notification to each channel URI. Although we have only demonstrated a single toast template, the push.wns.* namespace provides simple-to-use methods required for sending toast, tile and badge updates. As you can see in this scenario we are sending a ToastText04 template that requires three lines of text. When you build your applications we would advise that you do not send toast notifications so frequently but rather only at times when there is a critical or important message to deliver to the user of your application.</p>
</blockquote>
<p><img src="Images/image-22.png?raw=true" alt="Image 22" />
</p></li>
<li><p>In <strong>Visual Studio</strong> press <strong>F5</strong> to run the app.</p></li>
<li><p>Enter a <em>Todo item</em> and click <strong>Save</strong>. The toast notification will be displayed.</p>

<p><img src="Images/testing-push-notifications.png?raw=true" alt="Testing Push notifications" />
</p></li>
</ol>

<p>Next we will move on to look at how you can secure your Mobile Service endpoints.</p>

<p><a name="Exercise3"></a></p>

<h2 id="Exercise_3_Adding_Auth_to_Your_App_and_Services">Exercise 3: Adding Auth to Your App and Services</h2>

<p>This exercise shows how to authenticate users in Windows Azure Mobile Services from a Windows 8 app. In this exercise, you add authentication to the quickstart project using Microsoft Account. When successfully authenticated by a Microsoft Account your app will be able to consume your Mobile Service.</p>

<p><a name="Registering-your-app"></a></p>

<h3 id="Task_1_-_Registering_your_app">Task 1 - Registering your app</h3>

<p>To be able to authenticate users, you must register your Windows Store app within an Identity Provider. You must then register the obtained client secret to integrate the provider with Mobile Services.</p>

<p>The supported identity providers are listed below. In this exercise you will use <strong>Microsoft Account</strong> as the provider, nevertheless you can use the one of your preferences and you can follow the steps to register your app with that provider:</p>

<p><a href="http://www.windowsazure.com/en-us/develop/mobile/how-to-guides/register-for-microsoft-authentication/">Microsoft Account</a></p>

<p><a href="http://www.windowsazure.com/en-us/develop/mobile/how-to-guides/register-for-facebook-authentication/">Facebook login</a></p>

<p><a href="http://www.windowsazure.com/en-us/develop/mobile/how-to-guides/register-for-twitter-authentication/">Twitter login</a></p>

<p><a href="http://www.windowsazure.com/en-us/develop/mobile/how-to-guides/register-for-google-authentication/">Google login</a></p>

<ol>
<li><p>Navigate to the <a href="http://go.microsoft.com/fwlink/p/?linkid=262039&amp;clcid=0x409">My Applications</a> page in the Live Connect Developer Center, log on with your Microsoft account if needed.</p></li>
<li><p>Click your app name in the <strong>My applications</strong> list.</p>

<p><img src="Images/image-24.png?raw=true" alt="Image 24" />
</p></li>
<li><p>Click <strong>Edit settings</strong>, then <strong>API Settings</strong> and make a note of the value of <strong>Client secret</strong>. In <strong>Redirect domain</strong>, enter the domain of your mobile service, in the format <strong>https://[YOUR-SERVICE-NAME].azure-mobile.net/</strong>, where <em>YOUR-SERVICE-NAME</em> is the name of your mobile service, then click <strong>Save</strong>.</p>

<p><img src="Images/image-25.png?raw=true" alt="Image 25" />
</p>

<p>You must provide this value to Mobile Services to be able to use Live Connect for authentication.</p>
<blockquote>
<p><strong>Note:</strong> The client secret is an important security credential. Do not share the client secret with anyone or distribute it with your app.</p>
</blockquote></li>
<li><p>Return to the <a href="https://manage.windowsazure.com/">Windows Azure Management Portal</a>, click <strong>Mobile Services</strong>, and then click your app.</p>

<p><img src="Images/image-26.png?raw=true" alt="Image 26" />
</p></li>
<li><p>Click the <strong>Identity</strong> tab, enter the <strong>Client secret</strong> obtained from Live Connect, and click <strong>Save</strong>.</p>

<p><img src="Images/image-27.png?raw=true" alt="Image 27" />
</p></li>
</ol>

<p><a name="Restrict-permissions"></a></p>

<h3 id="Task_2_-_Restricting_permissions">Task 2 - Restricting permissions</h3>

<ol>
<li><p>In the Management Portal, click the <strong>Data</strong> tab, and then click the <strong>TodoItem</strong> table.</p>

<p><img src="Images/image-28.png?raw=true" alt="Image 28" />
</p></li>
<li><p>Click the <strong>Permissions</strong> tab, set all permissions to <strong>Only authenticated users</strong>, and then click <strong>Save</strong>. This will ensure that all operations against the <strong>TodoItem</strong> table require an authenticated user.</p>

<p><img src="Images/image-29.png?raw=true" alt="Image 29" />
</p></li>
<li><p>Return to Visual Studio 2012 and press the <strong>F5</strong> key to run this app; verify that an exception with a status code of 401 (Unauthorized) is raised.
This happens because the app is accessing Mobile Services as an unauthenticated user, but the <em>TodoItem</em> table now requires authentication.</p></li>
</ol>

<p>Next, you will update the app to authenticate users with your Microsoft Account before requesting resources from the mobile service.</p>

<p><a name="Add-authentication"></a></p>

<h3 id="Task_3_-_Adding_authentication_to_your_Windows_store_app">Task 3 - Adding authentication to your Windows store app</h3>

<ol>
<li><p>In the project in Visual Studio open <strong>MainPage.xaml.cs</strong>.</p></li>
<li><p>Update the <strong>OnNavigatedTo</strong> event handler to be async and add a call to the <strong>LoginAsync</strong> method:</p>

<!-- mark:1,3    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">protected</span> <span style="color:#0000FF">async</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> OnNavigatedTo(NavigationEventArgs e)</strong>
{
<strong class="markLine">    <span style="color:#0000FF">await</span> App.MobileService.LoginAsync(MobileServiceAuthenticationProvider.MicrosoftAccount);</strong>
    RefreshTodoItems();            
}
</code></pre></li>
<li><p>Press the <strong>F5</strong> key to run the app and sign into Live Connect with your Microsoft Account.</p>

<p>When you are successfully logged-in, the app will run without auth errors, and you will be able to query Mobile Services and make updates to data.</p></li>
</ol>

<p><a name="Exercise4"></a></p>

<h2 id="Exercise_4_Adding_a_Scheduled_Job_to_your_Mobile_Service">Exercise 4: Adding a Scheduled Job to your Mobile Service</h2>

<p>In this exercise you will learn how to execute a script on a scheduled basis using <strong>Windows Azure Mobile Services</strong>.  In this scenario we will configure the scheduler to poll Twitter every 15 minutes and then send a Tile update with the latest tweets.</p>

<p><a name="Configuring-your-windows-store-app-for-wide-tiles"></a></p>

<h3 id="Task_1_-_Configuring_your_Windows_store_app_for_Wide_Tiles">Task 1 - Configuring your Windows store app for Wide Tiles</h3>

<ol>
<li><p>In Visual Studio open your <strong>package.appxmanifest</strong> and select the <strong>Application UI</strong> tab.</p></li>
<li><p>Provide a <strong>Wide Tile Logo</strong> of 310x150 pixels. To do this, click <strong>Wide Logo</strong> in the <strong>All Image Assets</strong> and change the logo in the <strong>Wide Logo</strong> section. </p>

<p><img src="Images/image-37.png?raw=true" alt="Image 37" />
</p>
<blockquote>
<p><strong>Note:</strong> If you do not have an image of these dimensions available you can use Microsoft Paint to quickly create one.</p>
</blockquote></li>
</ol>

<h3 id="Task_2_-_Configuring_the_Mobile_Services_scheduler">Task 2 - Configuring the Mobile Services scheduler</h3>

<ol>
<li><p>In the <strong>scheduler</strong> tab, click on <strong>Create the scheduler job</strong> link.</p>

<p><img src="Images/image-38.png?raw=true" alt="Image 38" />
</p></li>
<li><p>Specify a name for the job and make sure the schedule frequency is set to <strong>every 15 minutes</strong>. Click the check mark to create the job.</p>

<p><img src="Images/image-39.png?raw=true" alt="Image 39" />
</p></li>
<li><p>Select the created job from the job list.</p>

<p><img src="Images/image-40.png?raw=true" alt="Image 40" />
</p></li>
<li><p>Select the <strong>Script</strong> tab and paste the code snippet below that both polls Twitter and then composes a push notification to update your start screens tile using push.wns.*</p>

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><span style="color:#0000FF">function</span> CheckFeed() {
     getUpdatesAndNotify();
}

<span style="color:#0000FF">var</span> request = require(&#39;request&#39;);
<span style="color:#0000FF">function</span> getUpdatesAndNotify() {  
     request(&#39;http:<span style="color:#008000">//search.twitter.com/search.json?q=@cloudnick&amp;rpp=2&#39;, </span>
      <span style="color:#0000FF">function</span> tweetsLoaded (error, response, body) {
          <span style="color:#0000FF">var</span> results = JSON.parse(body).results;
          <span style="color:#0000FF">if</span>(results){
                results.forEach(<span style="color:#0000FF">function</span> visitResult(tweet){
                 sendNotifications(tweet);
                });
          }            
      });
}

<span style="color:#0000FF">function</span> sendNotifications(tweet){    

<span style="color:#0000FF">var</span> channelTable = tables.getTable(&#39;Channel&#39;);
channelTable.read({
    success: <span style="color:#0000FF">function</span>(channels) {
         channels.forEach(<span style="color:#0000FF">function</span>(channel) {   

              push.wns.sendTileWideSmallImageAndText04(channel.uri, {
                    image1src: tweet.profile_image_url,                            
                    text1: &#39;@&#39; + tweet.from_user,
                    text2: tweet.text
              });                  

         });
    }
 });
}
</code></pre></li>
<li><p>Once you paste the script into the editor, click the <strong>Save</strong> button to store the changes to the script.</p>

<p><img src="Images/image-41.png?raw=true" alt="Image 41" />
</p></li>
<li><p>In Visual Studio, press <strong>F5</strong> to build and run the application.  This will ensure your channel URI is up to date and will ensure the Default Wide tile is now on your Start screen.</p></li>
<li><p>Go back to the Windows Azure Management Portal, select the <strong>Scheduler</strong> tab of your mobile service, and then click <strong>Enable</strong> in the command bar to allow the job to run.</p>

<p><img src="Images/image-42.png?raw=true" alt="Image 42" />
</p></li>
<li><p>To test your script immediately rather than wait 15 minutes for it to be scheduled, click <strong>Run Once</strong> in the command bar.</p>

<p><img src="Images/image-43.png?raw=true" alt="Image 43" />
</p></li>
<li><p>Return to the start screen and see the latest update on your application tile.</p>

<p><img src="Images/image-44.png?raw=true" alt="Image 44" />
</p></li>
</ol>

<p><a name="Summary"></a></p>

<h2 id="Summary">Summary</h2>

<p>By completing this hands-on lab you have learnt how to:</p>

<ul>
<li>Create a Windows Azure Mobile Service.</li>
<li>Use the Windows Azure Mobile Services SDK.</li>
<li>Learn how to Insert, Update, Read and Delete rows from a Mobile Service.</li>
<li>Add Push Notifications to your application.</li>
<li>Lock down your Mobile Service such that only authenticated users can consume it.</li>
<li>Use the Scheduler to execute scripts at a scheduled interval.</li>
</ul>

<hr />

</span>
		</div>
	<br />
	<p><a href="#top">top of page</a></p>


				</div>
			</section>
			<footer>
				<div class="footer-sitemap" style="border-top:0"></div>
				<div class="footer-bottom">
					<ul>
						<li class="footer-copyright"><a href="http://www.microsoft.com"><img alt="microsoft" src="images/microsoft.png" /></a></li>					
												<li><a href="https://github.com/WindowsAzure-TrainingKit/HOL-Windows8AndMobileServices/issues" target="_new">File an Issue</a></li>
												<li><a href="mailto:WindowsAzureTrainingKit@microsoft.onmicrosoft.com?subject=Windows Azure Training Kit">Contact Us</a></li>
						<li><a href="EULA.htm">Terms of Use</a></li>
						<li><a href=".\">Browse Content</a></li>
						<li>&copy; 2012 Microsoft</li>
					</ul>
				</div>
			</footer>
			</div>
        </div>
    </div>
</body>
</html>

